<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Wallet Pro V7</title>
    
    <!-- PWA & Icone Mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/3d-fluency/180/wallet.png">

    <!-- Librerie -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6;
            color: #1f2937;
            user-select: none;
        }
        
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide { animation: slideIn 0.3s ease-out; }
        
        @keyframes grow-bar { from { height: 0; } to { height: var(--target-height); } }
        .bar-grow { animation: grow-bar 0.8s ease-out forwards; }
        
        @keyframes flash-alert {
            0%, 100% { background-color: #fef2f2; border-color: #fecaca; }
            50% { background-color: #fff1f2; border-color: #fda4af; box-shadow: 0 0 12px rgba(244, 63, 94, 0.2); }
        }
        .animate-flash { animation: flash-alert 2s infinite; }

        .safe-pt { padding-top: env(safe-area-inset-top); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }

        .bank-input {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 14px;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            background: #fff;
            font-size: 16px;
        }
        .bank-input:focus { border-color: #1e40af; ring: 2px rgba(30, 64, 175, 0.1); }
        
        textarea.bank-input { font-family: monospace; font-size: 12px; line-height: 1.4; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- ICONE SPECIFICHE ---
        const Icons = {
            Wallet: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>,
            Plus: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Pencil: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            ChevronRight: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m9 18 6-6-6-6"/></svg>,
            ChevronLeft: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m15 18-6-6 6-6"/></svg>,
            Chart: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            Gear: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Cart: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>,
            Fuel: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M3 22V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v15"/><path d="M7 22v-4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v4"/><path d="M17 7h3.5a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5H17"/><circle cx="10" cy="10" r="2"/></svg>,
            Car: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>,
            Home: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Heart: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            Coffee: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>,
            Check: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
            Eye: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>,
            Bell: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            Copy: ({s=20, c=""}) => <svg width={s} height={s} className={c} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
        };

        const CATEGORIES = {
            spesa: { label: 'Spesa', icon: Icons.Cart, color: 'text-orange-600', bg: 'bg-orange-100', hex: '#ea580c' },
            benzina: { label: 'Benzina', icon: Icons.Fuel, color: 'text-yellow-600', bg: 'bg-yellow-100', hex: '#ca8a04' },
            auto: { label: 'Auto', icon: Icons.Car, color: 'text-blue-600', bg: 'bg-blue-100', hex: '#2563eb' },
            casa: { label: 'Casa', icon: Icons.Home, color: 'text-indigo-600', bg: 'bg-indigo-100', hex: '#4f46e5' },
            salute: { label: 'Salute', icon: Icons.Heart, color: 'text-red-600', bg: 'bg-red-100', hex: '#dc2626' },
            svago: { label: 'Svago', icon: Icons.Coffee, color: 'text-pink-600', bg: 'bg-pink-100', hex: '#db2777' },
            stipendio: { label: 'Stipendio', icon: Icons.Wallet, color: 'text-emerald-600', bg: 'bg-emerald-100', hex: '#059669' },
            altro: { label: 'Altro', icon: Icons.Wallet, color: 'text-gray-600', bg: 'bg-gray-100', hex: '#4b5563' },
            carta: { label: 'Saldo Carta', icon: Icons.Wallet, color: 'text-purple-600', bg: 'bg-purple-100', hex: '#9333ea' }
        };

        // --- COMPONENTE GRAFICO A BARRE VERTICALI ---
        const VerticalBarChart = ({ stats }) => {
            const { expenseStats, totalExpenses } = stats;
            const data = Object.entries(expenseStats)
                .sort(([,a], [,b]) => b - a)
                .map(([cat, amount]) => ({ cat, amount }));
            
            const maxVal = Math.max(...data.map(d => d.amount), 1);

            return (
                <div className="flex flex-col h-full animate-slide px-2">
                    <div className="text-center mb-8">
                        <span className="text-[10px] text-gray-400 font-black uppercase tracking-widest block mb-1">Totale Uscite Periodo</span>
                        <span className="text-3xl font-black text-gray-900">
                            {new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(totalExpenses)}
                        </span>
                    </div>

                    {/* Contenitore Grafico */}
                    <div className="flex items-end justify-center gap-4 mb-10 min-h-[200px] pt-10 px-4">
                        {data.map((item) => {
                            const heightPercentage = (item.amount / maxVal) * 100;
                            const catInfo = CATEGORIES[item.cat] || CATEGORIES.altro;
                            return (
                                <div key={item.cat} className="flex flex-col items-center justify-end w-10 group relative h-full">
                                    {/* Etichetta Valore al passaggio */}
                                    <div className="absolute -top-10 bg-gray-900 text-white text-[10px] py-1.5 px-2 rounded-lg opacity-0 group-active:opacity-100 transition-opacity whitespace-nowrap z-20 shadow-xl">
                                        {Math.round(item.amount)}€
                                    </div>
                                    
                                    {/* Barra Verticale */}
                                    <div 
                                        className="w-full rounded-t-xl rounded-b-lg bar-grow relative" 
                                        style={{ 
                                            "--target-height": `${Math.max(heightPercentage, 10)}%`,
                                            backgroundColor: catInfo.hex,
                                            height: 0 // Inizia da 0 per l'animazione
                                        }}
                                    >
                                        <div className="absolute top-2 left-1/2 -translate-x-1/2 text-[8px] font-black text-white/70">
                                            {Math.round((item.amount / totalExpenses) * 100)}%
                                        </div>
                                    </div>
                                    
                                    {/* Icona Sotto la Barra */}
                                    <div className={`mt-3 p-2 rounded-lg ${catInfo.bg} ${catInfo.color}`}>
                                        <catInfo.icon s={14} />
                                    </div>
                                    <span className="text-[7px] font-black text-gray-400 mt-1 uppercase tracking-tighter truncate w-full text-center">
                                        {catInfo.label}
                                    </span>
                                </div>
                            );
                        })}
                        {data.length === 0 && (
                            <div className="text-gray-300 italic text-sm py-20 text-center w-full">
                                Nessuna uscita registrata questo mese
                            </div>
                        )}
                    </div>

                    {/* Lista Dettagliata Sotto il Grafico */}
                    <div className="space-y-2 pb-10">
                        <h4 className="text-[10px] font-black text-gray-400 uppercase tracking-widest px-2 mb-2">Dettaglio Categorie</h4>
                        {data.map(item => (
                            <div key={item.cat} className="flex items-center justify-between p-4 bg-white rounded-2xl border border-gray-100 shadow-sm">
                                <div className="flex items-center gap-3">
                                    <div className="w-3 h-3 rounded-full" style={{backgroundColor: CATEGORIES[item.cat]?.hex}}></div>
                                    <span className="text-sm font-bold text-gray-700">{CATEGORIES[item.cat]?.label}</span>
                                </div>
                                <div className="text-right">
                                    <span className="text-sm font-black text-gray-900 block">
                                        {new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(item.amount)}
                                    </span>
                                    <span className="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">
                                        {Math.round((item.amount / totalExpenses) * 100)}% del totale
                                    </span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        function App() {
            const DB_KEY = 'wallet_pro_db_v7';
            const [transactions, setTransactions] = useState(() => {
                const saved = localStorage.getItem(DB_KEY);
                return saved ? JSON.parse(saved) : [];
            });

            const [view, setView] = useState('dashboard');
            const [showChartModal, setShowChartModal] = useState(false);
            const [selectedTx, setSelectedTx] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [privacy, setPrivacy] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [toast, setToast] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            const [jsonInputText, setJsonInputText] = useState("");
            const [showDeadlinesOnly, setShowDeadlinesOnly] = useState(false);
            const [editingId, setEditingId] = useState(null);

            const initialFormState = {
                amount: '', desc: '', cat: 'spesa', type: 'expense', method: 'standard',
                date: new Date().toISOString().split('T')[0]
            };

            const [form, setForm] = useState(initialFormState);

            useEffect(() => { localStorage.setItem(DB_KEY, JSON.stringify(transactions)); }, [transactions]);

            const showToast = (msg) => {
                setToast(msg);
                setTimeout(() => setToast(null), 2500);
            };

            const resetForm = () => setForm({ ...initialFormState, date: new Date().toISOString().split('T')[0] });

            // LOGICA SALDO CARTA (Virtuale)
            const processedTransactions = useMemo(() => {
                const ccExpensesByMonth = {};
                transactions.forEach(t => {
                    if (t.method === 'cc' && t.type === 'expense') {
                        const d = new Date(t.date);
                        const key = `${d.getFullYear()}-${d.getMonth()}`;
                        if (!ccExpensesByMonth[key]) ccExpensesByMonth[key] = { total: 0, date: d };
                        ccExpensesByMonth[key].total += parseFloat(t.amount);
                    }
                });

                const virtualTransactions = [];
                Object.keys(ccExpensesByMonth).forEach(key => {
                    const { total, date } = ccExpensesByMonth[key];
                    if (total > 0) {
                        const billDate = new Date(date.getFullYear(), date.getMonth() + 1, 15);
                        virtualTransactions.push({
                            id: `cc_bill_${key}`,
                            date: billDate.toISOString().split('T')[0],
                            amount: total,
                            desc: `Saldo Carta (${date.toLocaleDateString('it-IT', { month: 'long' })})`,
                            type: 'expense',
                            cat: 'carta',
                            isVirtual: true,
                            method: 'standard'
                        });
                    }
                });
                return [...transactions, ...virtualTransactions].sort((a,b) => new Date(b.date) - new Date(a.date));
            }, [transactions]);

            const upcomingDeadlines = useMemo(() => {
                const today = new Date(); today.setHours(0,0,0,0);
                const limit = new Date(today); limit.setDate(today.getDate() + 2);
                return processedTransactions.filter(t => {
                    const tDate = new Date(t.date); tDate.setHours(0,0,0,0);
                    return tDate > today && tDate <= limit;
                });
            }, [processedTransactions]);

            const stats = useMemo(() => {
                let bal = 0, inc = 0, exp = 0;
                const m = currentDate.getMonth(), y = currentDate.getFullYear();
                const today = new Date(); today.setHours(0,0,0,0);

                processedTransactions.forEach(t => {
                    const val = parseFloat(t.amount);
                    const tDate = new Date(t.date); tDate.setHours(0,0,0,0);
                    if (tDate <= today && t.method !== 'cc') {
                        if (t.type === 'income') bal += val; else bal -= val;
                    }
                    if (tDate.getMonth() === m && tDate.getFullYear() === y && !t.isVirtual) {
                         if (t.type === 'income') inc += val; else exp += val;
                    }
                });
                return { bal, inc, exp };
            }, [processedTransactions, currentDate]);

            const chartStats = useMemo(() => {
                const expS = {}; let totalExp = 0, totalInc = 0;
                const m = currentDate.getMonth(), y = currentDate.getFullYear();
                
                processedTransactions.forEach(t => {
                    const tDate = new Date(t.date);
                    // Solo transazioni reali del mese visualizzato (escludiamo i saldi carta virtuali per l'analisi pura delle spese)
                    if (tDate.getMonth() === m && tDate.getFullYear() === y && !t.isVirtual) {
                        const amt = parseFloat(t.amount);
                        if(t.type === 'expense') {
                            expS[t.cat] = (expS[t.cat] || 0) + amt;
                            totalExp += amt;
                        } else {
                            totalInc += amt;
                        }
                    }
                });
                return { expenseStats: expS, totalExpenses: totalExp, totalIncome: totalInc, balance: totalInc - totalExp };
            }, [processedTransactions, currentDate]);

            const saveTx = () => {
                if(!form.amount || !form.desc) return showToast("Dati mancanti.");
                if (editingId) {
                    setTransactions(transactions.map(t => t.id === editingId ? {...t, ...form} : t));
                    showToast("Aggiornato.");
                } else {
                    setTransactions([{...form, id: Date.now()}, ...transactions]);
                    showToast("Salvato.");
                }
                setView('dashboard');
                setEditingId(null);
                resetForm();
            };

            const importFromText = () => {
                if (!jsonInputText.trim()) return showToast("Incolla del testo.");
                try {
                    const data = JSON.parse(jsonInputText);
                    if (Array.isArray(data)) {
                        setTransactions(data);
                        showToast("Dati importati!");
                        setJsonInputText("");
                        setShowSettings(false);
                    } else { showToast("Formato non valido."); }
                } catch(e) { showToast("Errore JSON."); }
            };

            const formatMoney = (n) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(n);

            return (
                <div className="min-h-screen pb-20 safe-pt safe-pb bg-gray-100 overflow-x-hidden">
                    {toast && <div className="fixed top-8 left-1/2 -translate-x-1/2 z-[100] bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold animate-slide">{toast}</div>}

                    {/* DASHBOARD */}
                    {view === 'dashboard' && (
                        <div className="animate-slide">
                            <div className="bg-white px-6 pt-10 pb-4 border-b border-gray-200 sticky top-0 z-40">
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-blue-700 rounded-xl flex items-center justify-center text-white shadow-lg"><Icons.Wallet s={24} /></div>
                                        <span className="font-black text-2xl tracking-tight text-gray-900">Wallet Pro</span>
                                    </div>
                                    <div className="flex gap-4">
                                        <button onClick={() => setPrivacy(!privacy)} className="text-gray-400 active:text-blue-600">{privacy ? <Icons.EyeOff s={24} /> : <Icons.Eye s={24} />}</button>
                                        <button onClick={() => setShowChartModal(true)} className="text-gray-400 active:text-blue-600"><Icons.Chart s={24} /></button>
                                        <button onClick={() => setShowSettings(true)} className="text-gray-400 active:text-blue-600"><Icons.Gear s={24} /></button>
                                    </div>
                                </div>
                                <div className="flex items-center justify-between bg-gray-100 rounded-xl p-1">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()-1)))} className="p-2"><Icons.ChevronLeft s={20} /></button>
                                    <span className="font-bold text-xs uppercase text-gray-500">{currentDate.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}</span>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth()+1)))} className="p-2"><Icons.ChevronRight s={20} /></button>
                                </div>
                            </div>

                            <div className="p-6 space-y-6">
                                {/* BANNER SCADENZE */}
                                {upcomingDeadlines.length > 0 && (
                                    <button onClick={() => { setShowDeadlinesOnly(true); setSearchQuery(""); }} className="w-full bg-red-50 border border-red-200 rounded-2xl p-4 flex items-center gap-4 animate-flash">
                                        <div className="text-red-600 bg-white p-2 rounded-full shadow-sm"><Icons.Bell s={20} /></div>
                                        <div className="text-left flex-1">
                                            <p className="text-sm font-black text-red-900 leading-tight">Scadenze in arrivo!</p>
                                            <p className="text-xs text-red-600">Hai {upcomingDeadlines.length} movimenti nei prossimi 2 giorni.</p>
                                        </div>
                                        <Icons.ChevronRight s={18} c="text-red-300" />
                                    </button>
                                )}

                                {/* SALDO PRINCIPALE */}
                                <div className="bg-gradient-to-br from-blue-900 to-blue-700 rounded-3xl p-8 text-white shadow-2xl relative overflow-hidden">
                                    <div className="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                                    <p className="text-blue-200 text-xs font-bold uppercase tracking-widest mb-2">Saldo Disponibile</p>
                                    <h2 className="text-4xl font-black mb-8 tracking-tighter">
                                        {privacy ? "**** €" : formatMoney(stats.bal)}
                                    </h2>
                                    <div className="grid grid-cols-2 gap-6 pt-6 border-t border-white/10">
                                        <div>
                                            <p className="text-blue-200 text-[10px] uppercase font-bold mb-1 tracking-widest">Entrate Mese</p>
                                            <p className="text-lg font-black text-emerald-300">{formatMoney(stats.inc)}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-blue-200 text-[10px] uppercase font-bold mb-1 tracking-widest">Uscite Mese</p>
                                            <p className="text-lg font-black text-red-300">{formatMoney(stats.exp)}</p>
                                        </div>
                                    </div>
                                </div>

                                {/* RICERCA */}
                                <div className="relative">
                                    <input type="text" placeholder="Cerca descrizione..." value={searchQuery} onChange={(e) => {setSearchQuery(e.target.value); setShowDeadlinesOnly(false);}} className="bank-input pl-4 shadow-sm" />
                                </div>

                                {/* LISTA MOVIMENTI */}
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center px-1">
                                        <h3 className="text-xs font-black text-gray-400 uppercase tracking-widest">{showDeadlinesOnly ? "Solo Scadenze" : "Movimenti"}</h3>
                                        { (searchQuery || showDeadlinesOnly) && <button onClick={() => {setSearchQuery(""); setShowDeadlinesOnly(false);}} className="text-xs font-bold text-blue-600">Mostra tutti</button>}
                                    </div>
                                    
                                    {(showDeadlinesOnly ? upcomingDeadlines : processedTransactions.filter(t => {
                                        const d = new Date(t.date);
                                        const matchMonth = d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                                        const matchSearch = t.desc.toLowerCase().includes(searchQuery.toLowerCase()) || t.amount.toString().includes(searchQuery);
                                        return matchMonth && matchSearch;
                                    })).map(t => {
                                        const Cat = CATEGORIES[t.cat] || CATEGORIES.altro;
                                        const isFuture = new Date(t.date) > new Date();
                                        return (
                                            <div key={t.id} onClick={() => { if(!t.isVirtual) { setSelectedTx(t); setView('detail'); } }} className={`p-4 rounded-2xl border border-white bg-white shadow-sm flex items-center justify-between active:scale-95 transition-all ${isFuture ? 'opacity-60 bg-gray-50' : ''}`}>
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${Cat.bg} ${Cat.color}`}><Cat.icon s={20} /></div>
                                                    <div>
                                                        <p className="font-bold text-gray-900 text-sm">{t.desc}</p>
                                                        <p className="text-[10px] text-gray-400 font-bold uppercase">{new Date(t.date).toLocaleDateString('it-IT', {day:'2-digit', month:'short'})} {isFuture ? '• ATTESA' : ''}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className={`font-black text-sm ${t.type==='income'?'text-emerald-600':'text-gray-900'}`}>{t.type==='income'?'+':'-'} {formatMoney(t.amount)}</p>
                                                    {t.method==='cc' && !t.isVirtual && <span className="text-[8px] font-black bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded-full">CARTA</span>}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            <button onClick={() => { setEditingId(null); resetForm(); setView('add'); }} className="fixed bottom-10 right-8 bg-blue-700 text-white w-16 h-16 rounded-2xl shadow-2xl flex items-center justify-center active:scale-90 transition-all z-30"><Icons.Plus s={32} /></button>
                        </div>
                    )}

                    {/* MODALE IMPOSTAZIONI */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[100] flex items-end sm:items-center sm:justify-center p-4 bg-black/60 backdrop-blur-md">
                            <div className="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl animate-slide h-[85vh] flex flex-col">
                                <div className="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                                    <h3 className="text-xl font-black text-gray-800">Backup & Ripristino</h3>
                                    <button onClick={() => setShowSettings(false)} className="text-blue-600 font-bold">Chiudi</button>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-8 pr-1 no-scrollbar">
                                    <div className="space-y-3">
                                        <label className="block text-xs font-black text-gray-400 uppercase tracking-widest">Incolla Dati Vecchia Versione (JSON)</label>
                                        <textarea 
                                            rows="8" 
                                            placeholder='Incolla qui il codice JSON...'
                                            value={jsonInputText}
                                            onChange={(e) => setJsonInputText(e.target.value)}
                                            className="bank-input"
                                        />
                                        <button onClick={importFromText} className="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-all text-sm uppercase">Importa da Testo</button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => {
                                            const blob = new Blob([JSON.stringify(transactions)], {type: 'application/json'});
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url; a.download = 'wallet_backup.json'; a.click();
                                        }} className="p-4 bg-gray-100 text-gray-700 rounded-xl font-bold text-xs flex flex-col items-center gap-2"><Icons.Copy s={18} /> Scarica JSON</button>
                                        <button onClick={() => {
                                            let csv = "Data,Tipo,Cat,Desc,Importo\n";
                                            transactions.forEach(t => csv += `${t.date},${t.type},${t.cat},${t.desc},${t.amount}\n`);
                                            const blob = new Blob([csv], {type: 'text/csv'});
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url; a.download = 'export.csv'; a.click();
                                        }} className="p-4 bg-gray-100 text-gray-700 rounded-xl font-bold text-xs flex flex-col items-center gap-2"><Icons.Copy s={18} /> Esporta CSV</button>
                                    </div>
                                    <div className="p-4 bg-red-50 rounded-xl border border-red-100">
                                        <p className="text-[10px] text-red-500 font-black uppercase mb-2">Azione Irreversibile</p>
                                        <button onClick={() => { if(confirm("Cancellare tutto?")) setTransactions([]); }} className="text-red-600 text-sm font-bold">Resetta tutti i dati locali</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODALE ANALISI (Con Grafico a Barre Verticali) */}
                    {showChartModal && (
                        <div className="fixed inset-0 z-[100] flex items-end sm:items-center sm:justify-center p-4 bg-black/60 backdrop-blur-md">
                            <div className="bg-white w-full max-w-md rounded-t-[40px] sm:rounded-[40px] p-6 shadow-2xl animate-slide h-[85vh] flex flex-col">
                                <div className="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                                    <h3 className="text-xl font-black text-gray-800">Analisi Periodo</h3>
                                    <button onClick={() => setShowChartModal(false)} className="text-blue-600 font-bold">Chiudi</button>
                                </div>
                                <div className="flex-1 overflow-y-auto no-scrollbar">
                                    <VerticalBarChart stats={chartStats} />
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SCHERMATA AGGIUNTA/MODIFICA */}
                    {view === 'add' && (
                        <div className="fixed inset-0 z-[110] bg-gray-100 animate-slide flex flex-col h-full safe-pt safe-pb">
                            <div className="bg-white px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                <button onClick={() => { setView('dashboard'); setEditingId(null); resetForm(); }} className="text-gray-500 font-bold">Annulla</button>
                                <span className="font-black text-gray-900">{editingId ? "Modifica" : "Nuova Operazione"}</span>
                                <button onClick={saveTx} className="text-blue-600 font-black">Salva</button>
                            </div>
                            <div className="p-6 overflow-y-auto space-y-6">
                                <div className="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 text-center">
                                    <span className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 block">Importo</span>
                                    <div className="flex justify-center items-center text-5xl font-black text-gray-900">
                                        <span className="text-gray-300 mr-2 text-3xl">€</span>
                                        <input type="number" step="0.01" autoFocus placeholder="0.00" value={form.amount} onChange={e=>setForm({...form, amount: e.target.value})} className="w-44 text-center outline-none placeholder-gray-200" />
                                    </div>
                                </div>
                                <div className="bg-white rounded-2xl p-1 shadow-sm flex">
                                    <button onClick={()=>setForm({...form, type:'expense'})} className={`flex-1 py-3 text-xs font-black rounded-xl transition-all ${form.type==='expense'?'bg-red-50 text-red-600 shadow-inner':'text-gray-400'}`}>USCITA</button>
                                    <button onClick={()=>setForm({...form, type:'income'})} className={`flex-1 py-3 text-xs font-black rounded-xl transition-all ${form.type==='income'?'bg-emerald-50 text-emerald-600 shadow-inner':'text-gray-400'}`}>ENTRATA</button>
                                </div>
                                {form.type==='expense' && (
                                    <div className="bg-white rounded-2xl p-1 shadow-sm flex">
                                        <button onClick={()=>setForm({...form, method:'standard'})} className={`flex-1 py-2 text-[10px] font-black rounded-lg transition-all ${form.method === 'standard' ? 'bg-gray-800 text-white' : 'text-gray-400'}`}>CONTANTI/BANCOMAT</button>
                                        <button onClick={()=>setForm({...form, method:'cc'})} className={`flex-1 py-2 text-[10px] font-black rounded-lg transition-all ${form.method === 'cc' ? 'bg-purple-600 text-white' : 'text-gray-400'}`}>CARTA CREDITO (15 Mese Succ.)</button>
                                    </div>
                                )}
                                <div className="space-y-4">
                                    <input type="text" placeholder="Cosa hai comprato?" value={form.desc} onChange={e=>setForm({...form, desc: e.target.value})} className="bank-input shadow-sm" />
                                    <input type="date" value={form.date} onChange={e=>setForm({...form, date: e.target.value})} className="bank-input shadow-sm" />
                                    <div className="grid grid-cols-4 gap-4">
                                        {Object.entries(CATEGORIES).filter(([k]) => k !== 'carta').map(([k,v]) => (
                                            <button key={k} onClick={()=>setForm({...form, cat: k})} className={`flex flex-col items-center gap-2 p-3 rounded-2xl transition-all ${form.cat===k ? 'bg-blue-600 text-white shadow-xl scale-105' : 'bg-white text-gray-400 shadow-sm border border-gray-50'}`}>
                                                <v.icon s={20} />
                                                <span className="text-[9px] font-black uppercase">{v.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* DETTAGLIO MOVIMENTO */}
                    {view === 'detail' && selectedTx && (
                        <div className="fixed inset-0 z-[120] bg-gray-100 flex items-center justify-center p-6 backdrop-blur-sm bg-black/20">
                            <div className="bg-white w-full max-w-sm rounded-[40px] shadow-2xl overflow-hidden animate-slide">
                                <div className="p-4 flex justify-between items-center bg-gray-50 border-b border-gray-100">
                                    <button onClick={() => { setView('dashboard'); resetForm(); }} className="text-gray-400 font-bold p-2">Chiudi</button>
                                    <button onClick={() => { if(confirm("Eliminare definitivamente?")) { setTransactions(transactions.filter(t=>t.id!==selectedTx.id)); setView('dashboard'); } }} className="text-red-500 font-bold p-2 flex items-center gap-1"><Icons.Trash s={16} /> Elimina</button>
                                </div>
                                <div className="p-10 text-center">
                                    <div className={`w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl ${CATEGORIES[selectedTx.cat]?.bg} ${CATEGORIES[selectedTx.cat]?.color}`}>
                                        {React.createElement(CATEGORIES[selectedTx.cat]?.icon || Icons.Wallet, { s: 40 })}
                                    </div>
                                    <h2 className="text-2xl font-black text-gray-900 mb-2">{selectedTx.desc}</h2>
                                    <p className={`text-4xl font-black mb-8 ${selectedTx.type==='income'?'text-emerald-600':'text-gray-900'}`}>{formatMoney(selectedTx.amount)}</p>
                                    
                                    <div className="space-y-3">
                                        <button onClick={() => { setEditingId(selectedTx.id); setForm({...selectedTx}); setView('add'); }} className="w-full bg-gray-900 text-white font-black py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-all"><Icons.Pencil s={18} /> Modifica</button>
                                        {new Date(selectedTx.date) > new Date() && !selectedTx.isVirtual && (
                                            <button onClick={() => {
                                                const today = new Date().toISOString().split('T')[0];
                                                setTransactions(transactions.map(t => t.id === selectedTx.id ? {...t, date: today} : t));
                                                setView('dashboard');
                                                showToast("Contabilizzato oggi.");
                                            }} className="w-full bg-emerald-50 text-emerald-600 font-black py-4 rounded-2xl flex items-center justify-center gap-2"><Icons.Check s={18} /> Segna come pagato</button>
                                        )}
                                        <button onClick={() => {
                                            const d = new Date(selectedTx.date); d.setMonth(d.getMonth()+1);
                                            setTransactions([{...selectedTx, id: Date.now(), date: d.toISOString().split('T')[0]}, ...transactions]);
                                            setView('dashboard');
                                            showToast("Duplicato mese prossimo.");
                                        }} className="w-full bg-blue-50 text-blue-600 font-black py-4 rounded-2xl flex items-center justify-center gap-2"><Icons.Copy s={18} /> Duplica mese prossimo</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>